const express = require('express');
const app = express();
const axios = require('axios');

const apiUrl = 'https://demo-bots.kore.ai:443/chatbot/v2/webhook/st-60787ea9-b329-576d-80e1-0c8b71505ec9/hookInstance/ivrInst-6ad846f2-75b0-55a1-8029-aab86de09817';
const authToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcHBJZCI6ImNzLTg5ZTNiZGMyLTNiYTgtNWU4Ni1hODZmLTg4ZTZhZmZmNDU3ZCIsInN1YiI6InJlcG9ydGF1dG9tYXRpb24ifQ.QMszvgE-NLEB-HqUN0f1oQxQCFJ9pdv9NZPDf4jepFE'; // Replace with your actual auth token

const testFile = [1, 2, 3];
let currentTestIndex = 0;
const testCases = require(`./TestCases/${testFile[2]}.json`);

const axiosInstance = axios.create({
    baseURL: apiUrl,
    headers: {
        Authorization: `Bearer ${authToken}`
    },
});

function loadTestCase() {
    if (currentTestIndex < testFile.length) {
        return require(`./TestCases/${testFile[currentTestIndex]}.json`);
    } else {
        return null;
    }
}
// Message comparison function
function messageCompare(actual, expected) {
    if (actual.type === "text") {
        actual = actual.val.toLowerCase().replace(/[^a-z0-9]+/g, ' ');
        expected = expected.toLowerCase().replace(/[^a-z0-9]+/g, ' ');

        console.log("Actual:", actual + '\n');
        console.log("Expected:", expected + '\n');

        const expectedWords = expected.split(' ');
        const foundAllWords = expectedWords.every(word => actual.includes(word));

        if (foundAllWords) {
            console.log("-----Pass------" + '\n');
            return true;
        } else {
            console.log("-----Fail------"+ '\n');
            return false;
        }
    } else if (actual.type === "form") {
        console.log("Form"+ '\n');
        console.log("-----Pass------"+ '\n');
        return true;
    }
}

// Main function to handle responses and messages
async function handleResponse(response, expectedMessages, counter) {
    const data = response.data.data;
    
    for (let i = 0; i < data.length; i++) {
        if (i < expectedMessages.length) {
            if (!messageCompare(data[i], expectedMessages[i].contains)) {
                console.log("----test case failed----"+ '\n');
                return;
            }
        } else {
            flag = false
            console.log("Task ended2"+ '\n');
            return;
        }
    }

    if (counter < testCases.testCases[0].messages.length) {
        const message = testCases.testCases[0].messages[counter].input;
        const output = testCases.testCases[0].messages[counter].output;
        
        await sendMessage(message, output, counter + 1);
    } else {
        flag = true
        console.log('----test case passed----'+ '\n');
    }
}

// Function to send a message
async function sendMessage(message, expected, counter) {
    const requestData = {
        session: {
            new: counter === 1
        },
        message: {
            type: 'text',
            val: message
        },
        from: {
            id: 'U12345',
            userInfo: {
                firstName: 'Hari',
                lastName: 'Guptha',
                email: 'hariguptha.anbalagan@kore.com'
            }
        },
        mergeIdentity: true
    };

    try {
        const response = await axiosInstance.post('', requestData);
        await handleResponse(response, expected, counter);
    } catch (error) {
        console.error('Error:', error);
    }
}


async function runTests() {
    const testCases = loadTestCase();

    if (testCases) {
        console.log(`Running Test Case ${currentTestIndex + 1}`+ '\n');
        const message = testCases.testCases[0].messages[0].input;
        const output = testCases.testCases[0].messages[0].output;

        await sendMessage(message, output, 1);
        currentTestIndex++; // Move to the next test case
        runTests(); // Continue with the next test case
    } else {
        console.log('All test cases completed.'+ '\n');
        process.exit(0); // Exit the script when all tests are done
    }
}


app.listen(4001, () => {
    console.log("Script running");
    runTests(); // Start running tests
});
